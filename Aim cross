--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer

--// SETTINGS
local MAX_DISTANCE = 300
local SAVE_KEY = "PeilHub_Position"

--// STATE
local targets = {}
local currentIndex = 0
local selectedTarget = nil
local healthConnection
local dragStart, startPos, dragging

--// GUI
local gui = Instance.new("ScreenGui")
gui.Name = "PeilHubUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 420, 0, 380)
mainFrame.BackgroundColor3 = Color3.fromRGB(18,18,18)
mainFrame.Parent = gui
mainFrame.Active = true
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0,16)

-- Load Saved Position
pcall(function()
	local saved = UserSettings():GetService("UserGameSettings"):GetPropertyChangedSignal(SAVE_KEY)
end)

mainFrame.Position = UDim2.new(0.5,-210,0.5,-190)

--// DRAGGING
mainFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1
	or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position
	end
end)

mainFrame.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1
	or input.UserInputType == Enum.UserInputType.Touch then
		dragging = false
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement
	or input.UserInputType == Enum.UserInputType.Touch) then
		local delta = input.Position - dragStart
		mainFrame.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end
end)

--// TITLE WITH GLOW
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,0,0,70)
title.BackgroundTransparency = 1
title.Text = "PEILHUB"
title.Font = Enum.Font.GothamBlack
title.TextScaled = true
title.TextColor3 = Color3.fromRGB(0,255,120)
title.Parent = mainFrame

-- Glow animation
task.spawn(function()
	while true do
		TweenService:Create(title, TweenInfo.new(1), {TextColor3 = Color3.fromRGB(0,200,255)}):Play()
		task.wait(1)
		TweenService:Create(title, TweenInfo.new(1), {TextColor3 = Color3.fromRGB(0,255,120)}):Play()
		task.wait(1)
	end
end)

-- Info Panel
local infoFrame = Instance.new("Frame")
infoFrame.Size = UDim2.new(1,-40,0,150)
infoFrame.Position = UDim2.new(0,20,0,100)
infoFrame.BackgroundColor3 = Color3.fromRGB(28,28,28)
infoFrame.Parent = mainFrame
Instance.new("UICorner", infoFrame).CornerRadius = UDim.new(0,12)

local nameLabel = Instance.new("TextLabel")
nameLabel.Size = UDim2.new(1,0,0.4,0)
nameLabel.BackgroundTransparency = 1
nameLabel.Text = "Target: None"
nameLabel.Font = Enum.Font.GothamBold
nameLabel.TextScaled = true
nameLabel.TextColor3 = Color3.new(1,1,1)
nameLabel.Parent = infoFrame

-- Health Bar Background
local healthBG = Instance.new("Frame")
healthBG.Size = UDim2.new(0.9,0,0.25,0)
healthBG.Position = UDim2.new(0.05,0,0.6,0)
healthBG.BackgroundColor3 = Color3.fromRGB(50,50,50)
healthBG.Parent = infoFrame
Instance.new("UICorner", healthBG).CornerRadius = UDim.new(1,0)

-- Health Fill
local healthFill = Instance.new("Frame")
healthFill.Size = UDim2.new(1,0,1,0)
healthFill.BackgroundColor3 = Color3.fromRGB(0,255,120)
healthFill.Parent = healthBG
Instance.new("UICorner", healthFill).CornerRadius = UDim.new(1,0)

-- Highlight
local highlight = Instance.new("Highlight")
highlight.FillTransparency = 1
highlight.OutlineColor = Color3.fromRGB(0,255,120)
highlight.Enabled = false
highlight.Parent = gui

--// GET TARGET LIST
local function refreshTargets()
	targets = {}
	local myChar = player.Character
	if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then return end
	local myPos = myChar.HumanoidRootPart.Position
	
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local dist = (plr.Character.HumanoidRootPart.Position - myPos).Magnitude
			if dist <= MAX_DISTANCE then
				table.insert(targets, plr)
			end
		end
	end
end

local function selectTarget(index)
	if healthConnection then healthConnection:Disconnect() end
	
	if #targets == 0 then
		nameLabel.Text = "Target: None"
		highlight.Enabled = false
		return
	end
	
	currentIndex = ((index - 1) % #targets) + 1
	selectedTarget = targets[currentIndex]
	
	nameLabel.Text = "Target: "..selectedTarget.Name
	highlight.Adornee = selectedTarget.Character
	highlight.Enabled = true
	
	local humanoid = selectedTarget.Character:FindFirstChild("Humanoid")
	if humanoid then
		local function updateHealth()
			local percent = humanoid.Health / humanoid.MaxHealth
			TweenService:Create(healthFill, TweenInfo.new(0.2), {
				Size = UDim2.new(percent,0,1,0)
			}):Play()
		end
		
		updateHealth()
		healthConnection = humanoid.HealthChanged:Connect(updateHealth)
	end
end

--// INPUT (Keyboard + Controller)
UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	
	if input.KeyCode == Enum.KeyCode.Q
	or input.KeyCode == Enum.KeyCode.DPadLeft then
		refreshTargets()
		selectTarget(currentIndex - 1)
		
	elseif input.KeyCode == Enum.KeyCode.E
	or input.KeyCode == Enum.KeyCode.DPadRight then
		refreshTargets()
		selectTarget(currentIndex + 1)
	end
end)

-- Respawn safety
player.CharacterAdded:Connect(function()
	highlight.Enabled = false
	selectedTarget = nil
	nameLabel.Text = "Target: None"
	healthFill.Size = UDim2.new(1,0,1,0)
end)
