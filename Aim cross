-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- SETTINGS
local MAX_DISTANCE = 300
local LOS_BREAK_TIME = 2

local PREDICTION_STRENGTH = 0.12
local SOFT_LOCK_STRENGTH = 5
local HARD_LOCK_STRENGTH = 12

-- STATE
local tracking = false
local hardLock = false
local lockedTarget = nil
local losTimer = 0
local connection
local normalCameraType = camera.CameraType

-- UI
local gui = Instance.new("ScreenGui")
gui.Name = "AdvancedLockUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 260, 0, 50)
button.Position = UDim2.new(0.05, 0, 0.45, 0)
button.Text = "Tracking: OFF"
button.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
button.TextColor3 = Color3.fromRGB(255,255,255)
button.Font = Enum.Font.SourceSansBold
button.TextSize = 18
button.Parent = gui

-- Right click to toggle Hard Lock
button.MouseButton2Click:Connect(function()
	hardLock = not hardLock
	if hardLock then
		button.Text = "Hard Lock Mode"
	else
		button.Text = tracking and "Tracking: ON" or "Tracking: OFF"
	end
end)

-- DRAG (PC + MOBILE)
local dragging = false
local dragStart, startPos

button.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1
	or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = button.Position
	end
end)

button.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1
	or input.UserInputType == Enum.UserInputType.Touch then
		dragging = false
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement
	or input.UserInputType == Enum.UserInputType.Touch) then
		local delta = input.Position - dragStart
		button.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end
end)

-- ESP
local highlight = Instance.new("Highlight")
highlight.FillColor = Color3.fromRGB(255,0,0)
highlight.FillTransparency = 0.5
highlight.Enabled = false
highlight.Parent = gui

-- LOS
local function hasLOS(targetRoot)
	local myChar = player.Character
	if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then
		return false
	end

	local origin = myChar.HumanoidRootPart.Position
	local direction = targetRoot.Position - origin

	if direction.Magnitude > MAX_DISTANCE then
		return false
	end

	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Blacklist
	params.FilterDescendantsInstances = {myChar, targetRoot.Parent}

	return Workspace:Raycast(origin, direction, params) == nil
end

-- Find nearest
local function getNearestVisiblePlayer()
	local myChar = player.Character
	if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then
		return nil
	end

	local myPos = myChar.HumanoidRootPart.Position
	local closest, shortest = nil, math.huge

	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player then
			local char = plr.Character
			if char and char:FindFirstChild("HumanoidRootPart") then
				local root = char.HumanoidRootPart
				local dist = (root.Position - myPos).Magnitude
				if dist < shortest and dist <= MAX_DISTANCE and hasLOS(root) then
					shortest = dist
					closest = root
				end
			end
		end
	end

	return closest
end

-- TOGGLE LOCK
button.MouseButton1Click:Connect(function()
	tracking = not tracking

	if tracking then
		button.Text = "Tracking: ON"
		button.BackgroundColor3 = Color3.fromRGB(60,200,60)
		camera.CameraType = Enum.CameraType.Scriptable

		connection = RunService.RenderStepped:Connect(function(dt)

			if not lockedTarget then
				lockedTarget = getNearestVisiblePlayer()
				if lockedTarget then
					highlight.Adornee = lockedTarget.Parent
					highlight.Enabled = true
					losTimer = 0
				end
				return
			end

			if hasLOS(lockedTarget) then
				losTimer = 0
				highlight.Enabled = true

				-- ðŸŽ¯ PREDICTION
				local predictedPosition = lockedTarget.Position
				if lockedTarget.Parent:FindFirstChild("HumanoidRootPart") then
					local velocity = lockedTarget.Velocity
					predictedPosition += velocity * PREDICTION_STRENGTH
				end

				local camPos = camera.CFrame.Position
				local desired = CFrame.new(camPos, predictedPosition)

				-- ðŸ§² LOCK STRENGTH
				local strength = hardLock and HARD_LOCK_STRENGTH or SOFT_LOCK_STRENGTH
				local alpha = 1 - math.exp(-strength * dt * 10)

				camera.CFrame = camera.CFrame:Lerp(desired, alpha)
			else
				highlight.Enabled = false
				losTimer += dt
				if losTimer >= LOS_BREAK_TIME then
					lockedTarget = nil
				end
			end
		end)

	else
		button.Text = "no no"
		button.BackgroundColor3 = Color3.fromRGB(200,60,60)

		lockedTarget = nil
		highlight.Enabled = false
		highlight.Adornee = nil

		if connection then
			connection:Disconnect()
			connection = nil
		end

		camera.CameraType = normalCameraType
	end
end)
