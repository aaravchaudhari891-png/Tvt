--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

--// SETTINGS
local MAX_DISTANCE = 250
local SMOOTH_SPEED = 5

--// STATE
local selectedTarget = nil
local cinematicMode = false
local connection

--// UI SETUP
local gui = Instance.new("ScreenGui")
gui.Name = "PeilHubUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 400, 0, 340)
mainFrame.Position = UDim2.new(0.5, -200, 0.5, -170)
mainFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
mainFrame.Parent = gui
mainFrame.Active = true
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0,12)

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,0,0,60)
title.BackgroundTransparency = 1
title.Text = "PEILHUB"
title.Font = Enum.Font.GothamBlack
title.TextScaled = true
title.TextColor3 = Color3.fromRGB(0,255,120)
title.Parent = mainFrame

-- Button Creator
local function createButton(text, y)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1,-40,0,50)
	btn.Position = UDim2.new(0,20,0,y)
	btn.Text = text
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 18
	btn.TextColor3 = Color3.new(1,1,1)
	btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
	btn.Parent = mainFrame
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0,8)
	return btn
end

local selectBtn = createButton("Select Nearest Player", 80)
local cameraBtn = createButton("Cinematic Camera: OFF", 150)

-- Target Info Panel
local infoFrame = Instance.new("Frame")
infoFrame.Size = UDim2.new(1,-40,0,100)
infoFrame.Position = UDim2.new(0,20,0,230)
infoFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
infoFrame.Parent = mainFrame
Instance.new("UICorner", infoFrame).CornerRadius = UDim.new(0,8)

local nameLabel = Instance.new("TextLabel")
nameLabel.Size = UDim2.new(1,0,0.5,0)
nameLabel.BackgroundTransparency = 1
nameLabel.Text = "Target: None"
nameLabel.Font = Enum.Font.GothamBold
nameLabel.TextScaled = true
nameLabel.TextColor3 = Color3.new(1,1,1)
nameLabel.Parent = infoFrame

local healthLabel = Instance.new("TextLabel")
healthLabel.Size = UDim2.new(1,0,0.5,0)
healthLabel.Position = UDim2.new(0,0,0.5,0)
healthLabel.BackgroundTransparency = 1
healthLabel.Text = "Health: --"
healthLabel.Font = Enum.Font.Gotham
healthLabel.TextScaled = true
healthLabel.TextColor3 = Color3.fromRGB(0,255,120)
healthLabel.Parent = infoFrame

--// FIND NEAREST PLAYER
local function getNearestPlayer()
	local myChar = player.Character
	if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then return nil end
	
	local myPos = myChar.HumanoidRootPart.Position
	local closest, shortest = nil, math.huge
	
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local root = plr.Character.HumanoidRootPart
			local dist = (root.Position - myPos).Magnitude
			
			if dist < shortest and dist <= MAX_DISTANCE then
				shortest = dist
				closest = plr
			end
		end
	end
	
	return closest
end

--// SMOOTH CAMERA FOLLOW (NO AUTO AIM)
local function startCinematic()
	if connection then connection:Disconnect() end
	
	connection = RunService.RenderStepped:Connect(function(dt)
		if not selectedTarget then return end
		if not selectedTarget.Character then return end
		
		local root = selectedTarget.Character:FindFirstChild("HumanoidRootPart")
		if not root then return end
		
		local offset = root.CFrame.LookVector * -8 + Vector3.new(0,4,0)
		local desiredPos = root.Position + offset
		
		local desiredCF = CFrame.new(desiredPos, root.Position)
		
		local alpha = 1 - math.exp(-SMOOTH_SPEED * dt * 10)
		camera.CFrame = camera.CFrame:Lerp(desiredCF, alpha)
	end)
end

local function stopCinematic()
	if connection then connection:Disconnect() end
end

--// BUTTON EVENTS
selectBtn.MouseButton1Click:Connect(function()
	selectedTarget = getNearestPlayer()
	
	if selectedTarget then
		nameLabel.Text = "Target: " .. selectedTarget.Name
		
		local humanoid = selectedTarget.Character:FindFirstChild("Humanoid")
		if humanoid then
			healthLabel.Text = "Health: " .. math.floor(humanoid.Health)
			
			humanoid.HealthChanged:Connect(function()
				healthLabel.Text = "Health: " .. math.floor(humanoid.Health)
			end)
		end
	else
		nameLabel.Text = "Target: None"
		healthLabel.Text = "Health: --"
	end
end)

cameraBtn.MouseButton1Click:Connect(function()
	cinematicMode = not cinematicMode
	
	if cinematicMode then
		cameraBtn.Text = "Cinematic Camera: ON"
		cameraBtn.BackgroundColor3 = Color3.fromRGB(0,170,255)
		startCinematic()
	else
		cameraBtn.Text = "Cinematic Camera: OFF"
		cameraBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
		stopCinematic()
	end
end)
