--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

--// SETTINGS
local MAX_DISTANCE = 300
local LOS_BREAK_TIME = 2

local PREDICTION_STRENGTH = 0.12
local SOFT_LOCK_STRENGTH = 5
local HARD_LOCK_STRENGTH = 12

--// STATE
local tracking = false
local hardLock = false
local lockedTarget = nil
local losTimer = 0
local connection
local normalCameraType = camera.CameraType

--// UI CREATION
local gui = Instance.new("ScreenGui")
gui.Name = "PeilHubUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 350, 0, 300)
mainFrame.Position = UDim2.new(0.5, -175, 0.5, -150)
mainFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
mainFrame.Parent = gui
mainFrame.Active = true

local corner = Instance.new("UICorner", mainFrame)
corner.CornerRadius = UDim.new(0,12)

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,0,0,60)
title.BackgroundTransparency = 1
title.Text = "PEILHUB"
title.Font = Enum.Font.GothamBlack
title.TextScaled = true
title.TextColor3 = Color3.fromRGB(0,255,120)
title.Parent = mainFrame

-- Divider
local divider = Instance.new("Frame")
divider.Size = UDim2.new(1,-40,0,2)
divider.Position = UDim2.new(0,20,0,60)
divider.BackgroundColor3 = Color3.fromRGB(0,255,120)
divider.Parent = mainFrame

-- Button Creator
local function createButton(text, yPos)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1,-40,0,50)
	btn.Position = UDim2.new(0,20,0,yPos)
	btn.Text = text
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 18
	btn.TextColor3 = Color3.fromRGB(255,255,255)
	btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
	btn.Parent = mainFrame
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0,8)
	return btn
end

local toggleLockBtn = createButton("Lock: OFF", 80)
local hardLockBtn = createButton("Hard Lock: OFF", 150)

--// DRAGGING
local dragging, dragStart, startPos

mainFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1
	or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position
	end
end)

mainFrame.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1
	or input.UserInputType == Enum.UserInputType.Touch then
		dragging = false
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement
	or input.UserInputType == Enum.UserInputType.Touch) then
		local delta = input.Position - dragStart
		mainFrame.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end
end)

--// ESP
local highlight = Instance.new("Highlight")
highlight.FillColor = Color3.fromRGB(255,0,0)
highlight.FillTransparency = 0.5
highlight.Enabled = false
highlight.Parent = gui

--// LINE OF SIGHT
local function hasLOS(targetRoot)
	local myChar = player.Character
	if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then
		return false
	end

	local origin = myChar.HumanoidRootPart.Position
	local direction = targetRoot.Position - origin

	if direction.Magnitude > MAX_DISTANCE then
		return false
	end

	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Blacklist
	params.FilterDescendantsInstances = {myChar, targetRoot.Parent}

	return Workspace:Raycast(origin, direction, params) == nil
end

--// FIND TARGET
local function getNearestVisiblePlayer()
	local myChar = player.Character
	if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then
		return nil
	end

	local myPos = myChar.HumanoidRootPart.Position
	local closest, shortest = nil, math.huge

	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player then
			local char = plr.Character
			if char and char:FindFirstChild("HumanoidRootPart") then
				local root = char.HumanoidRootPart
				local dist = (root.Position - myPos).Magnitude
				if dist < shortest and dist <= MAX_DISTANCE and hasLOS(root) then
					shortest = dist
					closest = root
				end
			end
		end
	end

	return closest
end

--// LOCK SYSTEM
local function startTracking()
	camera.CameraType = Enum.CameraType.Scriptable

	connection = RunService.RenderStepped:Connect(function(dt)

		if not lockedTarget then
			lockedTarget = getNearestVisiblePlayer()
			if lockedTarget then
				highlight.Adornee = lockedTarget.Parent
				highlight.Enabled = true
				losTimer = 0
			end
			return
		end

		if hasLOS(lockedTarget) then
			losTimer = 0
			highlight.Enabled = true

			-- Prediction
			local predicted = lockedTarget.Position + (lockedTarget.Velocity * PREDICTION_STRENGTH)

			local camPos = camera.CFrame.Position
			local desired = CFrame.new(camPos, predicted)

			local strength = hardLock and HARD_LOCK_STRENGTH or SOFT_LOCK_STRENGTH
			local alpha = 1 - math.exp(-strength * dt * 10)

			camera.CFrame = camera.CFrame:Lerp(desired, alpha)
		else
			highlight.Enabled = false
			losTimer += dt
			if losTimer >= LOS_BREAK_TIME then
				lockedTarget = nil
			end
		end
	end)
end

local function stopTracking()
	if connection then
		connection:Disconnect()
		connection = nil
	end
	camera.CameraType = normalCameraType
	lockedTarget = nil
	highlight.Enabled = false
	highlight.Adornee = nil
end

--// BUTTON EVENTS
toggleLockBtn.MouseButton1Click:Connect(function()
	tracking = not tracking

	if tracking then
		toggleLockBtn.Text = "Lock: ON"
		toggleLockBtn.BackgroundColor3 = Color3.fromRGB(0,200,100)
		startTracking()
	else
		toggleLockBtn.Text = "Lock: OFF"
		toggleLockBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
		stopTracking()
	end
end)

hardLockBtn.MouseButton1Click:Connect(function()
	hardLock = not hardLock
	if hardLock then
		hardLockBtn.Text = "Hard Lock: ON"
		hardLockBtn.BackgroundColor3 = Color3.fromRGB(200,0,0)
	else
		hardLockBtn.Text = "Hard Lock: OFF"
		hardLockBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
	end
end)
